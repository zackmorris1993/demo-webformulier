<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>T 01.01 - Subsidiaries</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9fb; margin:0; padding:30px; }
    h2 { color: #004080; margin-bottom:10px; }
    a.help-link { font-size:0.9em; color:#004080; text-decoration:underline; cursor:pointer; }
    .help-box { display:none; background:#e6f4ff; padding:15px; margin:10px 0 20px; border-left:4px solid #004080; border-radius:4px; color:#003366; }
    table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 0 8px rgba(0,0,0,0.1); margin-bottom:20px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#f0f6ff; color:#004080; }
    input[type="number"] { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
    .button-group { display:flex; justify-content:space-between; gap:10px; }
    .button-group button { background:#004080; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; transition:background 0.2s; }
    .button-group button:hover { background:#003060; }
    .delete-button { background:transparent; border:none; color:red; font-size:1.2em; cursor:pointer; }
    /* searchable dropdown CSS */
    .country-cell { position: relative; }
    .country-input { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
    .country-dropdown {
      position: absolute; top: 100%; left: 0; right: 0;
      background: white; border:1px solid #ccc;
      max-height:150px; overflow-y:auto; display:none; z-index:10;
    }
    .country-dropdown div { padding:5px 10px; cursor:pointer; }
    .country-dropdown div:hover { background:#e6f4ff; }
  </style>
</head>
<body>

  <h2>T 01.01 - Subsidiaries</h2>
  <a class="help-link" onclick="toggleHelp()"> Hulp bij invullen</a>
  <div id="helpBox" class="help-box">
    <p>Rapporteurs geven hier posities aan het begin en eind van het jaar op voor deelnemingen (participating interests) en directe holdings. ‚Ä¶</p>
    <hr>
    <strong>Valideringsregels (taxonomie):</strong>
    <ul>
      <li><code>dnb_v0056 (ERROR)</code>: Als <strong>010 &gt; 300 000 000</strong>, moet 020 zijn ingevuld.</li>
      <li><code>dnb_v0057 (WARNING)</code>: Als <strong>010 &lt; 300 000 000</strong>, dan <strong>010 &lt; 020</strong>.</li>
      <li><code>dnb_v0054 (ERROR)</code>: <strong>030 ‚â• ‚Äì30 000 000</strong> (Dividend niet negatief).</li>
      <li><code>dnb_v0058 (ERROR)</code>: <strong>040 ‚â• 0</strong> (Operationeel resultaat niet negatief).</li>
      <!-- voeg hier overige regels toe -->
    </ul>
  </div>

  <!-- formulier -->
  <form onsubmit="return false;">
    <table id="subsidiariesTable">
      <thead>
        <tr>
          <th>Country of counterparty</th>
          <th>Position beginning (010)</th>
          <th>Position end (020)</th>
          <th>Dividend received (030)</th>
          <th>Operational result (040)</th>
          <th>Verwijder rij</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="country-cell">
            <input type="text" class="country-input" placeholder="Typ om te zoeken‚Ä¶" required>
            <div class="country-dropdown"></div>
          </td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><button class="delete-button" onclick="removeRow(this)">üóë</button></td>
        </tr>
      </tbody>
    </table>

    <div class="button-group">
      <button type="button" onclick="addRow()">‚ûï Voeg rij toe</button>
      <button type="button" id="nextBtn">Volgende ‚ûî</button>
    </div>
  </form>

  <!-- verborgen volledige landenlijst -->
  <ul id="allCountries" style="display:none;">
    <li>Netherlands</li><li>Belgium</li><li>Germany</li><li>France</li>
    <li>United Kingdom</li><li>United States</li>
    <!-- ‚Ä¶ voeg hier ALLE overige landen toe ‚Ä¶ -->
  </ul>

  <script>
    // help toggle
    function toggleHelp(){
      const h=document.getElementById('helpBox');
      h.style.display = h.style.display==='block'? 'none':'block';
    }
    // rows toevoegen/verwijderen
    function addRow(){
      const tb=document.querySelector('#subsidiariesTable tbody');
      const nr=tb.rows[0].cloneNode(true);
      nr.querySelectorAll('input').forEach(e=>e.value='');
      tb.appendChild(nr);
    }
    function removeRow(btn){
      const tb=document.querySelector('#subsidiariesTable tbody');
      if(tb.rows.length>1) btn.closest('tr').remove();
      else alert('Minstens √©√©n rij is vereist.');
    }

    // searchable country dropdown
    document.addEventListener('DOMContentLoaded', ()=>{
      const countries=Array.from(document.querySelectorAll('#allCountries li')).map(li=>li.textContent);
      const table=document.getElementById('subsidiariesTable');

      table.addEventListener('input', e=>{
        if(!e.target.classList.contains('country-input')) return;
        const input=e.target, dd=input.nextElementSibling;
        const val=input.value.toLowerCase();
        dd.innerHTML = countries.filter(c=>c.toLowerCase().includes(val))
                                .map(c=>`<div>${c}</div>`).join('');
        dd.style.display = dd.innerHTML? 'block':'none';
      });

      table.addEventListener('click', e=>{
        if(e.target.parentNode.classList.contains('country-dropdown')){
          const input=e.target.closest('.country-cell').querySelector('.country-input');
          input.value=e.target.textContent;
          e.target.parentNode.style.display='none';
        }
      });

      document.addEventListener('click', e=>{
        if(!e.target.classList.contains('country-input'))
          document.querySelectorAll('.country-dropdown').forEach(d=>d.style.display='none');
      });
    });

    // taxonomie-validatie (zoals eerder)
    const rules=[
      {id:'dnb_v0056',sev:'ERROR',validate:r=>{
         const a=+r.cells[1].querySelector('input').value||0, b=r.cells[2].querySelector('input').value;
         return !(a>300000000 && !b);
       },msg:'010 >300 000 000 ‚Üí vul ook 020 in'},
      {id:'dnb_v0057',sev:'WARNING',validate:r=>{
         const a=+r.cells[1].querySelector('input').value||0, b=+r.cells[2].querySelector('input').value||0;
         return !(a<300000000 && a>=b);
       },msg:'010 moet <020 wanneer <300 000 000'},
      {id:'dnb_v0054',sev:'ERROR',validate:r=>(+r.cells[3].querySelector('input').value||0)>=-30000000, msg:'030 ‚â• ‚Äì30 000 000'},
      {id:'dnb_v0058',sev:'ERROR',validate:r=>(+r.cells[4].querySelector('input').value||0)>=0, msg:'040 ‚â• 0'}
    ];
    function runValidation(){
      const rows=[...document.querySelectorAll('#subsidiariesTable tbody tr')], errs=[], warns=[];
      rows.forEach((r,i)=> rules.forEach(rule=>{
        if(!rule.validate(r)) (rule.sev==='ERROR'?errs:warns).push(`Rij ${i+1}[${rule.id}]: ${rule.msg}`);
      }));
      return {errs,warns};
    }
    document.getElementById('nextBtn').addEventListener('click',function(){
      const {errs,warns}=runValidation(), msgs=[];
      if(errs.length) msgs.push('üõë Errors:\n'+errs.join('\n'));
      if(warns.length) msgs.push('‚ö†Ô∏è Warnings:\n'+warns.join('\n'));
      if(msgs.length){
        alert(msgs.join('\n\n'));
      } else {
        parent.loadForm('reporting-t01-02.html',
          parent.document.querySelector('.sidebar button[onclick*="reporting-t01-02.html"]')
        );
      }
    });
  </script>

</body>
</html>
