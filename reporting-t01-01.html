<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>T 01.01 - Subsidiaries</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9fb; margin:0; padding:30px; }
    h2 { color: #004080; margin-bottom:10px; }
    a.help-link { font-size:0.9em; color:#004080; text-decoration:underline; cursor:pointer; }
    .help-box { display:none; background:#e6f4ff; padding:15px; margin:10px 0 20px; border-left:4px solid #004080; border-radius:4px; color:#003366; }
    table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 0 8px rgba(0,0,0,0.1); margin-bottom:20px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#f0f6ff; color:#004080; }
    input[type="number"], .country-input { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
    .button-group { display:flex; justify-content:space-between; gap:10px; }
    .button-group button { background:#004080; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; transition:background 0.2s; }
    .button-group button:hover { background:#003060; }
    .delete-button { background:transparent; border:none; color:red; font-size:1.2em; cursor:pointer; }
    /* searchable dropdown CSS */
    .country-cell { position: relative; }
    .country-dropdown {
      position: absolute; top: 100%; left: 0; right: 0;
      background: white; border:1px solid #ccc;
      max-height:150px; overflow-y:auto; display:none; z-index:10;
    }
    .country-dropdown div { padding:5px 10px; cursor:pointer; }
    .country-dropdown div:hover { background:#e6f4ff; }

    /* ERROR‚ÄêHIGHLIGHTING */
    .error-cell { background-color: #e60000 !important; }

    /* invulvelden binnen kolommen fitten */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* Validatieberichten */
    #validationMessages {
      padding: 12px;
      border-radius: 4px;
    }
    #validationMessages .error {
      background-color: #f8d7da;
      color: #721c24;
      border-left: 4px solid #f5c6cb;
    }
    #validationMessages .warning {
      background-color: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffeeba;
    }

      /* VALIDATIERAPPORT */
    #validationReport {
      font-size: 0.95em;
    }
    #validationReport details {
      margin-bottom: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      overflow: hidden;
    }
    #validationReport summary {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      cursor: pointer;
    }
    #validationReport summary.error-summary {
      background: #fdd;
    }
    #validationReport summary.error-summary .badge {
      background: #e60000;  
    }
    #validationReport summary.warn-summary {
      background: #ffd;
    }
    #validationReport summary.warn-summary .badge {
      background: #e69500;
    }
    #validationReport summary .badge {
      margin-left: auto;
      padding: 2px 8px;
      border-radius: 12px;
      color: white;
      font-weight: bold;
    }
    #validationReport ul {
      margin: 0;
      padding: 10px 20px;
      list-style: none;
    }
    #validationReport li {
      padding: 4px 0;
      cursor: pointer;
      color: #004080;
    }
    #validationReport li:hover {
      text-decoration: underline;
      background: #f0f6ff;
    }

    /* Validatierapport styling */
#validationReport {
  margin-bottom: 20px;
}
#validationReport h3 {
  margin: 0 0 8px;
  color: #004080;
  font-size: 1.1em;
}
#validationMessages {
  padding: 12px;
  border-radius: 4px;
}
#validationMessages .error {
  background-color: #f8d7da;
  color: #721c24;
  border-left: 4px solid #f5c6cb;
}
#validationMessages .warning {
  background-color: #fff3cd;
  color: #856404;
  border-left: 4px solid #ffeeba;
}

    /* Zorg dat er wat ruimte komt onder de help-link */
.help-link {
  display: inline-block;    /* zodat margin-bottom werkt */
  margin-bottom: 12px;
}

/* Of: extra ruimte bovenaan het validatierapport */
#validationReport {
  margin-top: 12px;
}


  </style>
</head>
<body>

  <h2>T 01.01 - Subsidiaries</h2>
  <a class="help-link" onclick="toggleHelp()">Hulp bij invullen</a>
  <div id="helpBox" class="help-box">
    <p>Rapporteurs geven hier posities aan het begin en eind van het jaar op voor deelnemingen (participating interests) en directe holdings. Dit kunnen binnen- en buitenlandse deelnemingen zijn. ‚Ä¶</p>
    <hr>
    <strong>Valideringsregels (taxonomie):</strong>
    <ul>
      <li><code>dnb_v0056 (ERROR)</code>: Als <strong>010 &gt; 300 000 000</strong>, moet 020 zijn ingevuld.</li>
      <li><code>dnb_v0057 (WARNING)</code>: Als <strong>010 &lt; 300 000 000</strong>, dan <strong>010 &lt; 020</strong>.</li>
      <li><code>dnb_v0054 (ERROR)</code>: <strong>030 ‚â• ‚Äì30 000 000</strong> (Dividend niet negatief).</li>
      <li><code>dnb_v0058 (ERROR)</code>: <strong>040 ‚â• 0</strong> (Operationeel resultaat niet negatief).</li>
    </ul>
  </div>

  <form onsubmit="return false;">
    <!-- VALIDATIERAPPORT -->
    <section id="validationReport" style="display:none;">
      <h3>Validatierapport</h3>
      <div id="validationMessages"></div>
    </section>
    
    <!-- Tabel per formulier -->
    <table id="subsidiariesTable">
      <thead>
        <tr>
          <th>Country of counterparty</th>
          <th>Position beginning (010)</th>
          <th>Position end (020)</th>
          <th>Dividend received (030)</th>
          <th>Operational result (040)</th>
          <th>Verwijder rij</th>
        </tr>
      </thead>
      <tbody>
        <tr class="template-row">
          <td class="country-cell">
            <input type="text" class="country-input" placeholder="Typ om te zoeken‚Ä¶" required>
            <div class="country-dropdown"></div>
          </td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><button class="delete-button" onclick="removeRow(this)">üóë</button></td>
        </tr>
      </tbody>
    </table>

    <div class="button-group">
      <button type="button" onclick="addRow()">‚ûï Voeg rij toe</button>
      <button type="button" onclick="resetTable()">üîÑ Reset formulier</button>
      <button type="button" id="nextBtn">Volgende formulier</button>
    </div>
  </form>

  <!-- volledige landenlijst -->
  <ul id="allCountries" style="display:none;">
    <li>Netherlands</li><li>Belgium</li><li>Germany</li><li>France</li>
    <li>United Kingdom</li><li>United States</li>
    <!-- ‚Ä¶alle overige landen‚Ä¶ -->
  </ul>

  <script>
    function resetTable() {
      // 1) wis alle rijen
      tbody.innerHTML = '';
      // 2) voeg precies 1 lege template-rij toe
      addRow();
      // 3) verwijder oude highlights
      clearHighlights();
    }
    
    // help togglen
    function toggleHelp() {
      const hb = document.getElementById('helpBox');
      hb.style.display = hb.style.display==='block'? 'none':'block';
    }

    // template‚Äêrij bewaren
    const tbody = document.querySelector('#subsidiariesTable tbody');
    const templateRow = tbody.querySelector('.template-row').cloneNode(true);

    // rijen toevoegen / verwijderen
    function addRow() {
      const tr = templateRow.cloneNode(true);
      tr.querySelectorAll('input').forEach(i=>i.value='');
      tbody.appendChild(tr);
    }
    function removeRow(btn) {
      if (tbody.rows.length > 1) btn.closest('tr').remove();
      else alert('Minstens √©√©n rij is vereist.');
    }

    // searchable dropdown
    document.addEventListener('DOMContentLoaded', ()=>{
      const countries = Array.from(document.querySelectorAll('#allCountries li'))
                             .map(li=>li.textContent);
      tbody.addEventListener('input', e=>{
        if (!e.target.classList.contains('country-input')) return;
        const dd = e.target.nextElementSibling;
        const val = e.target.value.toLowerCase();
        dd.innerHTML = countries
          .filter(c=>c.toLowerCase().includes(val))
          .map(c=>`<div>${c}</div>`).join('');
        dd.style.display = dd.innerHTML? 'block':'none';
      });
      tbody.addEventListener('click', e=>{
        if (e.target.parentNode.classList.contains('country-dropdown')) {
          const inp = e.target.closest('.country-cell')
                          .querySelector('.country-input');
          inp.value = e.target.textContent;
          e.target.parentNode.style.display='none';
        }
      });
      document.addEventListener('click', e=>{
        if (!e.target.classList.contains('country-input'))
          document.querySelectorAll('.country-dropdown')
                  .forEach(d=>d.style.display='none');
      });
    });

    // Excel‚Äêimport
    document.addEventListener('DOMContentLoaded', ()=>{
      const key = Object.keys(localStorage).find(k=>k.startsWith('T01.01'));
      if (!key) return;
      const data = JSON.parse(localStorage.getItem(key));
      const rows = data.slice(1);
      tbody.innerHTML = '';
      rows.forEach(cols=>{
        const tr = templateRow.cloneNode(true);
        tr.cells[0].querySelector('input').value = cols[0]||'';
        for (let i=1; i<=4; i++){
          tr.cells[i].querySelector('input').value = cols[i]!=null? cols[i]:'';
        }
        tbody.appendChild(tr);
      });
    });

    // ** Validation + highlighting **
    const rules = [
      {id:'dnb_v0056',sev:'ERROR',validate:r=>{
         const a=+r.cells[1].querySelector('input').value||0,
               b=r.cells[2].querySelector('input').value;
         return !(a>300000000 && !b);
      }},
      {id:'dnb_v0057',sev:'WARNING',validate:r=>{
         const a=+r.cells[1].querySelector('input').value||0,
               b=+r.cells[2].querySelector('input').value||0;
         return !(a<300000000 && a>=b);
      }},
      {id:'dnb_v0054',sev:'ERROR',validate:r=>
         (+r.cells[3].querySelector('input').value||0) >= -30000000},
      {id:'dnb_v0058',sev:'ERROR',validate:r=>
         (+r.cells[4].querySelector('input').value||0) >= 0}
    ];

    function runValidation(){
      const errs=[], warns=[];
      Array.from(tbody.rows).forEach((r,i)=>{
        rules.forEach(rule=>{
          if (!rule.validate(r)) {
            (rule.sev==='ERROR'? errs:warns)
             .push({ row:i, rule:rule.id });
          }
        });
      });
      return {errs, warns};
    }

    function clearHighlights(){
      document.querySelectorAll('.error-cell')
              .forEach(el=>el.classList.remove('error-cell'));
    }

    function markErrors(errs){
      errs.forEach(e=>{
        const row = tbody.rows[e.row];
        let idx = 1;
        switch(e.rule){
          case 'dnb_v0056': idx = 2; break;
          case 'dnb_v0057': idx = 1; break;
          case 'dnb_v0054': idx = 3; break;
          case 'dnb_v0058': idx = 4; break;
        }
        const inp = row.cells[idx].querySelector('input');
        if (inp) inp.classList.add('error-cell');
      });
    }

    const ruleDescriptions = {
      dnb_v0056: 'Als beginpositie > 300 000 000, moet slotpositie zijn ingevuld.',
      dnb_v0057: 'Als beginpositie < 300 000 000, hoort deze < slotpositie.',
      dnb_v0054: 'Dividend mag niet negatief zijn.',
      dnb_v0058: 'Operationeel resultaat mag niet negatief zijn.'
    };

    document.getElementById('nextBtn').addEventListener('click', () => {
  clearHighlights();
  const {errs, warns} = runValidation();

  const reportSection = document.getElementById('validationReport');
  const container     = document.getElementById('validationMessages');

  if (errs.length || warns.length) {
    // 1) Bouw de HTML
    let html = '';
    if (errs.length) {
      html += `<div class="error"><strong>üõë Errors:</strong><ul>`;
      errs.forEach(e => {
        html += `<li>Rij ${e.row+1} [${e.rule}]</li>`;
      });
      html += `</ul></div>`;
    }
    if (warns.length) {
      html += `<div class="warning"><strong>‚ö†Ô∏è Warnings:</strong><ul>`;
      warns.forEach(e => {
        html += `<li>Rij ${e.row+1} [${e.rule}]</li>`;
      });
      html += `</ul></div>`;
    }

    // 2) Toon sectie en berichten
    reportSection.style.display      = 'block';
    container.innerHTML              = html;
    markErrors(errs);

    // klik‚Äêhandler voor scrollen
    Array.from(report.querySelectorAll('li')).forEach(li => {
      li.addEventListener('click', () => {
        const r = +li.dataset.row, c = +li.dataset.col;
        const inp = tbody.rows[r].cells[c].querySelector('input');
        inp.scrollIntoView({ behavior:'smooth', block:'center' });
        inp.focus();
      });
    });

  } else {
    report.style.display = 'none';
    parent.loadForm(
      'reporting-t01-02.html',
      parent.document.querySelector('.sidebar button[onclick*="reporting-t01-02.html"]')
    );
  }
});

    

  </script>

</body>
</html>
