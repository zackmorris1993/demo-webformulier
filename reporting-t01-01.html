<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>T 01.01 - Subsidiaries</title>
  <style>
  /* basis */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    font-family: Arial, sans-serif;
    background: #f9f9fb;
    margin: 0;
    padding: 30px;
  }
  h2 {
    color: #004080;
    margin-bottom: 10px;
  }

  /* Vraagkaart bovenaan */
  .question-card {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .question-card p {
    margin: 0 0 12px;
    font-size: 1em;
    color: #004080;
  }
  .question-buttons button {
    background: #004080;
    color: #fff;
    border: none;
    padding: 8px 16px;
    margin-right: 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .question-buttons button:hover {
    background: #003060;
  }
    
  /* help-link */
  .help-link {
    display: inline-block;
    font-size: 0.9em;
    color: #004080;
    text-decoration: underline;
    cursor: pointer;
    margin-bottom: 12px; /* extra ruimte onder ‚ÄúHulp bij invullen‚Äù */
  }
  .help-box {
    display: none;
    background: #e6f4ff;
    padding: 15px;
    margin: 10px 0 20px;
    border-left: 4px solid #004080;
    border-radius: 4px;
    color: #003366;
  }

  /* tabel */
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
  }
  th {
    background: #f0f6ff;
    color: #004080;
  }
  input[type="number"], .country-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  /* knoppen */
  .button-group {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }
  .button-group button {
    background: #004080;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .button-group button:hover {
    background: #003060;
  }
  .delete-button {
    background: transparent;
    border: none;
    color: red;
    font-size: 1.2em;
    cursor: pointer;
  }

  /* searchable dropdown */
  .country-cell {
    position: relative;
  }
  .country-dropdown {
    position: absolute;
    top: 100%; left: 0; right: 0;
    background: white;
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    display: none;
    z-index: 10;
  }
  .country-dropdown div {
    padding: 5px 10px;
    cursor: pointer;
  }
  .country-dropdown div:hover {
    background: #e6f4ff;
  }

  /* error highlighting */
  .error-cell {
    background-color: #e60000 !important;
  }

  /* ‚Äî‚Äî‚Äî VALIDATIERAPPORT ‚Äî‚Äî‚Äî */
  #validationReport {
    display: none;               /* wordt via JS zichtbaar gemaakt */
    background-color: #fff;      /* wit kaartje */
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 20px;
    margin: 12px 0 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    font-size: 0.95em;
  }
  #validationReport h3 {
    margin-top: 0;
    margin-bottom: 12px;
    color: #004080;
    font-size: 1.2em;
  }

  /* inline error/warning blokken */
  #validationMessages .error {
    background-color: white;
    color: #004080;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
  }
  #validationMessages .warning {
    background-color: white;
    color: #004080;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
  }

  /* details/summary styling */
  #validationReport details {
    margin-bottom: 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: #fff;
    overflow: hidden;
  }
  #validationReport summary {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
  }
  #validationReport summary.error-summary {
    background: #fff;
  }
  #validationReport summary.error-summary .badge {
    background: #004080;
  }
  #validationReport summary.warn-summary {
    background: #fff;
  }
  #validationReport summary.warn-summary .badge {
    background: #004080;
  }
  #validationReport summary .badge {
    margin-left: auto;
    padding: 2px 8px;
    border-radius: 12px;
    color: white;
    font-weight: bold;
  }
  #validationReport ul {
    margin: 0;
    padding: 10px 20px;
    list-style: none;
  }
  #validationReport li {
    padding: 4px 0;
    cursor: pointer;
    color: #004080;
  }
  #validationReport li:hover {
    background: #f0f6ff;
    text-decoration: underline;
  }

  /* Succes‚Äêbericht */
  #validationMessages .success {
    background-color: #d4edda;
    color: #155724;
    border-left: 4px solid #c3e6cb;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 12px;
  }
  </style>

</head>
<body>

  <h2>T 01.01 - Subsidiaries</h2>
  <a class="help-link" onclick="toggleHelp()">Hulp bij invullen</a>
  <div id="helpBox" class="help-box">
    <p>Rapporteurs geven hier posities aan het begin en eind van het jaar op voor deelnemingen (participating interests) en directe holdings. Dit kunnen binnen- en buitenlandse deelnemingen zijn. ‚Ä¶</p>
    <hr>
    <strong>Valideringsregels (taxonomie):</strong>
    <ul>
      <li><code>dnb_v0056 (ERROR)</code>: Als <strong>010 &gt; 300 000 000</strong>, moet 020 zijn ingevuld.</li>
      <li><code>dnb_v0057 (WARNING)</code>: Als <strong>010 &lt; 300 000 000</strong>, dan <strong>010 &lt; 020</strong>.</li>
      <li><code>dnb_v0054 (ERROR)</code>: <strong>030 ‚â• ‚Äì30 000 000</strong> (Dividend niet negatief).</li>
      <li><code>dnb_v0058 (ERROR)</code>: <strong>040 ‚â• 0</strong> (Operationeel resultaat niet negatief).</li>
    </ul>
  </div>
  <div id="initialQuestion" class="question-card">
    <p>Heeft u in de rapportageperiode 01-01-2024 t/m 31-12-2024 posities in dochterondernemingen gehad?</p>
    <div class="button-group question-buttons">
      <button id="questionYes">Ja</button>
      <button id="questionNo">Nee</button>
    </div>
  </div>
  

  <form onsubmit="return false;">
    <!-- VALIDATIERAPPORT -->
    <section id="validationReport" style="display:none;">
      <h3>Validatierapport</h3>
      <div id="validationMessages"></div>
    </section>
    
    <div id="validationMessages" style="display:none;"></div>
    <section id="validationReport" style="display:none;"></section>
    
    <!-- Tabel per formulier -->
    <table id="subsidiariesTable">
      <thead>
        <tr>
          <th>Country of counterparty</th>
          <th>Position beginning (010)</th>
          <th>Position end (020)</th>
          <th>Dividend received (030)</th>
          <th>Operational result (040)</th>
          <th>Verwijder rij</th>
        </tr>
      </thead>
      <tbody>
        <tr class="template-row">
          <td class="country-cell">
            <input type="text" class="country-input" placeholder="Typ om te zoeken‚Ä¶" required>
            <div class="country-dropdown"></div>
          </td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><input type="number" step="0.01" required></td>
          <td><button class="delete-button" onclick="removeRow(this)">üóë</button></td>
        </tr>
      </tbody>
    </table>

    <div class="button-group">
      <button type="button" onclick="addRow()">‚ûï Voeg rij toe</button>
      <button type="button" onclick="resetTable()">üîÑ Reset formulier</button>
      <button type="button" id="nextBtn">Valideer</button>
    </div>
  </form>

  <!-- volledige landenlijst -->
  <ul id="allCountries" style="display:none;">
    <li>Netherlands</li><li>Belgium</li><li>Germany</li><li>France</li>
    <li>United Kingdom</li><li>United States</li>
    <!-- ‚Ä¶alle overige landen‚Ä¶ -->
  </ul>

<script>
window.addEventListener('DOMContentLoaded', () => {
  //
  // 1) ALLER EERST: Globale referenties & hulpfuncties
  //
  const tbody         = document.querySelector('#subsidiariesTable tbody');
  const templateRow   = tbody.querySelector('.template-row').cloneNode(true);
  const btnAddRow     = document.getElementById('addRowBtn');
  const btnReset      = document.getElementById('resetBtn');
  const btnNext       = document.getElementById('nextBtn');
  const reportSection = document.getElementById('validationReport');
  const msgContainer  = document.getElementById('validationMessages');
  const helpLink      = document.getElementById('helpLink');

  // Voeg √©√©n lege rij toe
  function addRow() {
    const tr = templateRow.cloneNode(true);
    tr.querySelectorAll('input').forEach(i=>i.value='');
    tbody.appendChild(tr);
  }

  function removeRow(btn) {
    if (tbody.rows.length > 1) btn.closest('tr').remove();
    else alert('Minstens √©√©n rij is vereist.');
  }

  function clearHighlights() {
    document.querySelectorAll('.error-cell')
            .forEach(el=>el.classList.remove('error-cell'));
  }

  function resetTable() {
    if (!confirm('Weet u zeker dat u het formulier wilt resetten? Alle data gaat verloren.')) {
      return;
    }
    // Opschonen localStorage
    Object.keys(localStorage)
      .filter(k=>k.startsWith('T01.01'))
      .forEach(k=>localStorage.removeItem(k));
    // Reset DOM
    tbody.innerHTML = '';
    addRow();
    clearHighlights();
    reportSection.style.display = 'none';
    msgContainer .style.display = 'none';
  }

  // Validatieregels & beschrijvingen
  const rules = [
    { id:'dnb_v0056', sev:'ERROR', validate: r => { /* ... */ }},
    { id:'dnb_v0057', sev:'WARNING', validate: r => { /* ... */ }},
    { id:'dnb_v0054', sev:'ERROR', validate: r => { /* ... */ }},
    { id:'dnb_v0058', sev:'ERROR', validate: r => { /* ... */ }},
  ];
  const ruleDescriptions = {
    dnb_v0056: 'Als beginpositie > 300 000 000, moet slotpositie ingevuld zijn.',
    dnb_v0057: 'Als beginpositie < 300 000 000, hoort deze < slotpositie.',
    dnb_v0054: 'Dividend mag niet negatief zijn.',
    dnb_v0058: 'Operationeel resultaat mag niet negatief zijn.'
  };

  function runValidation(){
    const errs = [], warns = [];
    Array.from(tbody.rows).forEach((r,i)=>{
      rules.forEach(rule=>{
        if (!rule.validate(r)) {
          (rule.sev==='ERROR' ? errs : warns).push({ row:i, rule:rule.id });
        }
      });
    });
    return { errs, warns };
  }

  function markErrors(errs){
    const colMap = {
      dnb_v0056: 2,
      dnb_v0057: 1,
      dnb_v0054: 3,
      dnb_v0058: 4
    };
    errs.forEach(e => {
      const inp = tbody.rows[e.row].cells[colMap[e.rule]].querySelector('input');
      if (inp) inp.classList.add('error-cell');
    });
  }

  function toggleHelp(){
    const hb = document.getElementById('helpBox');
    hb.style.display = hb.style.display==='block'? 'none':'block';
  }

  //
  // 2) BLANK-MODUS: vraag v√≥√≥r de rest
  //
  if (sessionStorage.getItem('reportStartMode') === 'blank') {
    const qCard  = document.getElementById('initialQuestion');
    const formEl = document.querySelector('form');
    const yesBtn = document.getElementById('questionYes');
    const noBtn  = document.getElementById('questionNo');

    qCard.style.display = 'block';
    formEl.style.display = 'none';

    yesBtn.addEventListener('click', () => {
      qCard.style.display = 'none';
      formEl.style.display = 'block';
      // 1 lege rij
      tbody.innerHTML = '';
      addRow();
      clearHighlights();
      reportSection.style.display = 'none';
      msgContainer .style.display = 'none';
    });

    noBtn.addEventListener('click', () => {
      parent.loadForm(
        'reporting-t01-02.html',
        parent.document.querySelector('.sidebar button[onclick*="reporting-t01-02.html"]')
      );
    });

    return; // **stop** verdere initialisatie
  }
  
// 3) NORMALE INITIALISATIE (Excel import, events binden, validation)
  
// ‚Äì **Excel-import**  
// Lees, parse en laad de sheet uit localStorage in de tabel
const sheetKey = Object.keys(localStorage).find(k=>k.startsWith('T01.01'));
if (sheetKey) {
  const data = JSON.parse(localStorage.getItem(sheetKey));
  const rows = data.slice(1);    // header weg
  tbody.innerHTML = '';          // wis template-rijen
  rows.forEach(cols => {
    const tr = templateRow.cloneNode(true);
    // kolom 0 = country
    tr.cells[0].querySelector('input').value = cols[0]||'';
    // kolom 1‚Äì4
    for (let i=1; i<=4; i++) {
      tr.cells[i].querySelector('input').value = cols[i] != null ? cols[i] : '';
    }
    tbody.appendChild(tr);
  });
}

// ‚Äì **Row-verwijderen** via event-delegation  
// Zo hoeft je in de markup geen inline onclick te doen.
tbody.addEventListener('click', e => {
  if (e.target.classList.contains('delete-button')) {
    // gebruik je bestaande removeRow-functie
    removeRow(e.target);
  }
});

// ‚Äì **Help-link** (als je nog geen id hebt gezet)
helpLink.addEventListener('click', toggleHelp);

// ‚Äì **Andere init**  
// Hier kun je nog andere event listeners zetten, bv. voor dynamic dropdowns,
// of direct validatie lanceren bij wijziging.

  // Knoppen binden
  btnAddRow .addEventListener('click', addRow);
  btnReset  .addEventListener('click', resetTable);
  helpLink  .addEventListener('click', toggleHelp);

  btnNext.addEventListener('click', function handler() {
    clearHighlights();
    const { errs, warns } = runValidation();

    reportSection.style.display = 'none';
    msgContainer .style.display = 'none';

    if (errs.length || warns.length) {
      let html = '<h3>Validatierapport</h3>';

      if (errs.length) {
        html += '<div class="error"><strong>üõë Errors:</strong><ul>';
        errs.forEach(e => {
          html += `<li>Rij ${e.row+1} [${e.rule}]: ${ruleDescriptions[e.rule]}</li>`;
        });
        html += '</ul></div>';
      }
      if (warns.length) {
        html += '<div class="warning"><strong>‚ö†Ô∏è Warnings:</strong><ul>';
        warns.forEach(e => {
          html += `<li>Rij ${e.row+1} [${e.rule}]: ${ruleDescriptions[e.rule]}</li>`;
        });
        html += '</ul></div>';
      }

      reportSection.innerHTML    = html;
      reportSection.style.display = 'block';
      markErrors(errs);

    } else {
      msgContainer.innerHTML = `
        <div class="success-box">
          ‚úÖ De door u ingevoerde data is gevalideerd. U kunt nu verder.
        </div>`;
      msgContainer.style.display = 'block';

      // volgende klik navigeert
      btnNext.textContent = 'Naar volgend formulier';
      btnNext.removeEventListener('click', handler);
      btnNext.addEventListener('click', () => {
        parent.loadForm(
          'reporting-t01-02.html',
          parent.document.querySelector('.sidebar button[onclick*="reporting-t01-02.html"]')
        );
      });
    }
  });

  // start altijd met 1 lege rij
  addRow();
});
</script>



</body>
</html>
